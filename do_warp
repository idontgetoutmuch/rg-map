#! /usr/bin/env nix-shell
#! nix-shell -i bash -p gdal

if [[ $# -eq 0 ]] ; then
    echo 'Must pass output directory'
    exit 1
fi

OUTPATH=$(readlink -f $1)

echo $OUTPATH

rm "$OUTPATH/warped/"*

for i in $(ls $OUTPATH/*.jpg | xargs -n 1 basename ); do
  gdalwarp -s_srs EPSG:4326 -t_srs EPSG:3857 -of VRT -co tiled=yes -dstnodata 0 "$OUTPATH/$i" "$OUTPATH/warped/$i.vrt"
done

gdalbuildvrt all.vrt $OUTPATH/warped/*.jpg.vrt
